From 8c867958ad7610a6ff424a62e7360f3247c65786 Mon Sep 17 00:00:00 2001
From: Callum <38501234+calumari@users.noreply.github.com>
Date: Mon, 1 Jun 2020 02:56:43 +0100
Subject: [PATCH] Passive mobs retaliate

---
 .../net/minecraft/server/EntityChicken.java   | 39 ++++++++++++++++++-
 .../conduit/config/ConduitWorldConfig.java    |  9 +++++
 2 files changed, 46 insertions(+), 2 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityChicken.java b/src/main/java/net/minecraft/server/EntityChicken.java
index 65795fc89..c87c781bb 100644
--- a/src/main/java/net/minecraft/server/EntityChicken.java
+++ b/src/main/java/net/minecraft/server/EntityChicken.java
@@ -1,5 +1,7 @@
 package net.minecraft.server;
 
+import javax.annotation.Nullable; // Conduit
+
 public class EntityChicken extends EntityAnimal {
 
     private static final RecipeItemStack bD = RecipeItemStack.a(Items.WHEAT_SEEDS, Items.MELON_SEEDS, Items.PUMPKIN_SEEDS, Items.BEETROOT_SEEDS);
@@ -20,7 +22,7 @@ public class EntityChicken extends EntityAnimal {
     @Override
     protected void initPathfinder() {
         this.goalSelector.a(0, new PathfinderGoalFloat(this));
-        this.goalSelector.a(1, new PathfinderGoalPanic(this, 1.4D));
+        // this.goalSelector.a(1, new PathfinderGoalPanic(this, 1.4D)); // Conduit - moved to prepare
         this.goalSelector.a(2, new PathfinderGoalBreed(this, 1.0D));
         this.goalSelector.a(3, new PathfinderGoalTempt(this, 1.0D, false, EntityChicken.bD));
         this.goalSelector.a(4, new PathfinderGoalFollowParent(this, 1.1D));
@@ -122,7 +124,11 @@ public class EntityChicken extends EntityAnimal {
         if (nbttagcompound.hasKey("EggLayTime")) {
             this.eggLayTime = nbttagcompound.getInt("EggLayTime");
         }
-
+        // Conduit start
+        if (world.conduitConfig.chickenRetaliateEnabled && nbttagcompound.getBoolean("Conduit.Retaliate")) {
+            this.setRetaliate();
+        }
+        // Conduit end
     }
 
     @Override
@@ -130,6 +136,7 @@ public class EntityChicken extends EntityAnimal {
         super.b(nbttagcompound);
         nbttagcompound.setBoolean("IsChickenJockey", this.bC);
         nbttagcompound.setInt("EggLayTime", this.eggLayTime);
+        nbttagcompound.setBoolean("Conduit.Retaliate", retaliate); // Conduit
     }
 
     @Override
@@ -159,4 +166,32 @@ public class EntityChicken extends EntityAnimal {
     public void r(boolean flag) {
         this.bC = flag;
     }
+
+    // Conduit start
+
+    private boolean retaliate;
+
+    @Override
+    public GroupDataEntity prepare(GeneratorAccess generatoraccess, DifficultyDamageScaler difficultydamagescaler, EnumMobSpawn enummobspawn, @Nullable GroupDataEntity groupdataentity, @Nullable NBTTagCompound nbttagcompound) {
+        if (world.conduitConfig.chickenRetaliateEnabled && world.conduitConfig.chickenRetaliateChance > 0 && this.random.nextDouble() < world.conduitConfig.chickenRetaliateChance) {
+            this.setRetaliate();
+        } else {
+            this.goalSelector.a(1, new PathfinderGoalPanic(this, 1.4D));
+        }
+
+        return super.prepare(generatoraccess, difficultydamagescaler, enummobspawn, groupdataentity, nbttagcompound);
+    }
+
+    @Override
+    public boolean B(Entity entity) {
+        return entity.damageEntity(DamageSource.mobAttack(this), world.conduitConfig.chickenRetaliateAttackDamage);
+    }
+
+    private void setRetaliate() {
+        this.goalSelector.a(4, new PathfinderGoalMeleeAttack(this, 1.0D, false));
+        this.targetSelector.a(1, new PathfinderGoalHurtByTarget(this));
+        this.retaliate = true;
+    }
+
+    // Conduit end
 }
diff --git a/src/main/java/net/socialhangover/conduit/config/ConduitWorldConfig.java b/src/main/java/net/socialhangover/conduit/config/ConduitWorldConfig.java
index b06845d60..9521f712b 100644
--- a/src/main/java/net/socialhangover/conduit/config/ConduitWorldConfig.java
+++ b/src/main/java/net/socialhangover/conduit/config/ConduitWorldConfig.java
@@ -99,4 +99,13 @@ public class ConduitWorldConfig {
         idleTimeoutSpawnNearbyEntities = getBoolean("gameplay-mechanics.idle-timeout.spawn-nearby-entities", true);
         idleTimeoutCountAsSleeping = getBoolean("gameplay-mechanics.idle-timeout.count-as-sleeping", false);
     }
+
+    public boolean chickenRetaliateEnabled;
+    public double chickenRetaliateChance;
+    public float chickenRetaliateAttackDamage;
+    private void chickenSettings() {
+        chickenRetaliateEnabled = getBoolean("mobs.chicken.retaliate.enabled", false);
+        chickenRetaliateChance = getDouble("mobs.chicken.retaliate.chance", 0.1D);
+        chickenRetaliateAttackDamage = (float) getDouble("mobs.chicken.retaliate.attack-damage", 3.0D);
+    }
 }
-- 
2.24.1.windows.2

