From f87c4b722e76940e0cf7f940375d0234f1aeb390 Mon Sep 17 00:00:00 2001
From: Callum <38501234+calumari@users.noreply.github.com>
Date: Mon, 25 May 2020 02:37:32 +0100
Subject: [PATCH] Allow villager leashing

---
 .../minecraft/server/EntityInsentient.java    | 22 ++++++++++---------
 .../net/minecraft/server/EntityVillager.java  |  7 ++++++
 .../server/EntityVillagerTrader.java          |  7 ++++++
 3 files changed, 26 insertions(+), 10 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityInsentient.java b/src/main/java/net/minecraft/server/EntityInsentient.java
index 5aca7a913..82e3e1b6d 100644
--- a/src/main/java/net/minecraft/server/EntityInsentient.java
+++ b/src/main/java/net/minecraft/server/EntityInsentient.java
@@ -1,24 +1,23 @@
 package net.minecraft.server;
 
 import com.google.common.collect.Maps;
+import org.bukkit.craftbukkit.entity.CraftLivingEntity;
+import org.bukkit.craftbukkit.event.CraftEventFactory;
+import org.bukkit.event.entity.EntityCombustByEntityEvent;
+import org.bukkit.event.entity.EntityTargetEvent;
+import org.bukkit.event.entity.EntityTargetLivingEntityEvent;
+import org.bukkit.event.entity.EntityUnleashEvent;
+import org.bukkit.event.entity.EntityUnleashEvent.UnleashReason;
+
+import javax.annotation.Nullable;
 import java.util.Arrays;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
 import java.util.Random;
 import java.util.UUID;
-import javax.annotation.Nullable;
 
 // CraftBukkit start
-import org.bukkit.craftbukkit.event.CraftEventFactory;
-import org.bukkit.craftbukkit.entity.CraftLivingEntity;
-import org.bukkit.entity.LivingEntity;
-import org.bukkit.event.entity.EntityCombustByEntityEvent;
-import org.bukkit.event.entity.EntityPickupItemEvent;
-import org.bukkit.event.entity.EntityTargetLivingEntityEvent;
-import org.bukkit.event.entity.EntityTargetEvent;
-import org.bukkit.event.entity.EntityUnleashEvent;
-import org.bukkit.event.entity.EntityUnleashEvent.UnleashReason;
 // CraftBukkit end
 
 public abstract class EntityInsentient extends EntityLiving {
@@ -1054,6 +1053,9 @@ public abstract class EntityInsentient extends EntityLiving {
         if (!this.isAlive()) {
             return false;
         } else if (this.getLeashHolder() == entityhuman) {
+            if (enumhand == EnumHand.OFF_HAND && this instanceof EntityVillagerAbstract) {
+                return true;
+            }
             // CraftBukkit start - fire PlayerUnleashEntityEvent
             if (CraftEventFactory.callPlayerUnleashEntityEvent(this, entityhuman).isCancelled()) {
                 ((EntityPlayer) entityhuman).playerConnection.sendPacket(new PacketPlayOutAttachEntity(this, this.getLeashHolder()));
diff --git a/src/main/java/net/minecraft/server/EntityVillager.java b/src/main/java/net/minecraft/server/EntityVillager.java
index 1094324d0..3913aa0c3 100644
--- a/src/main/java/net/minecraft/server/EntityVillager.java
+++ b/src/main/java/net/minecraft/server/EntityVillager.java
@@ -987,4 +987,11 @@ public class EntityVillager extends EntityVillagerAbstract implements Reputation
         this.bL = restocksToday;
     }
     // Paper end
+
+    // Conduit start
+    @Override
+    public boolean a(EntityHuman entityHuman) {
+        return !this.isLeashed();
+    }
+    // Conduit end
 }
diff --git a/src/main/java/net/minecraft/server/EntityVillagerTrader.java b/src/main/java/net/minecraft/server/EntityVillagerTrader.java
index 2ad8dba5c..92bc0471c 100644
--- a/src/main/java/net/minecraft/server/EntityVillagerTrader.java
+++ b/src/main/java/net/minecraft/server/EntityVillagerTrader.java
@@ -264,4 +264,11 @@ public class EntityVillagerTrader extends EntityVillagerAbstract {
             return !blockposition.a((IPosition) this.a.getPositionVector(), d0);
         }
     }
+
+    // Conduit start
+    @Override
+    public boolean a(EntityHuman entityHuman) {
+        return !this.isLeashed();
+    }
+    // Conduit end
 }
-- 
2.24.1.windows.2

