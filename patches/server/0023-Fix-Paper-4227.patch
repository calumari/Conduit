From 8d7085e75992b22127c03c960a8f91d3260597a9 Mon Sep 17 00:00:00 2001
From: Callum <38501234+calumari@users.noreply.github.com>
Date: Fri, 28 Aug 2020 00:42:33 +0100
Subject: [PATCH] Fix Paper 4227

---
 src/main/java/net/minecraft/server/EntityItem.java | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityItem.java b/src/main/java/net/minecraft/server/EntityItem.java
index cfb31c412c..11aa18fdee 100644
--- a/src/main/java/net/minecraft/server/EntityItem.java
+++ b/src/main/java/net/minecraft/server/EntityItem.java
@@ -388,10 +388,15 @@ public class EntityItem extends Entity {
                     return;
                 }
 
-                // Update the ItemStack incase it was changed in the event
-                itemstack = this.getItemStack();
-                canHold = entityhuman.inventory.canHold(itemstack);
-                remaining = itemstack.getCount() - canHold;
+                // Paper start - Only update the stack WHEN it has actually changed in the event. Prevents the incorrect count being used and items being deleted.
+                ItemStack nextItemStack = this.getItemStack();
+                if (!nextItemStack.equals(itemstack)) {
+                    // Update the ItemStack incase it was changed in the event
+                    itemstack = nextItemStack;
+                    canHold = entityhuman.inventory.canHold(itemstack);
+                    remaining = itemstack.getCount() - canHold;
+                }
+                // Paper end
 
                 itemstack.setCount(canHold + remaining); // = i
 
-- 
2.28.0.windows.1

